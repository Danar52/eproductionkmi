<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Input Produksi</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="assets/style/styleindex.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2>Input Data Produksi</h2>
    <form id="produksiForm">
      <div class="form-group">
        <label for="tanggal">Tanggal</label>
        <input type="date" name="Tanggal" id="tanggal" readonly required />
      </div>

      <div class="form-group">
        <label for="customer">Customer</label>
        <select name="Customer" id="customer" required>
          <option value="">--Pilih Customer--</option>
        </select>
      </div>

      <div class="form-group">
        <label for="partName">Part Name</label>
        <select name="Part Name" id="partName" required>
          <option value="">--Pilih Part--</option>
        </select>
      </div>

      <div class="form-group">
        <label for="partNumber">Part Number</label>
        <input type="text" name="Part Number" id="partNumber" readonly />
      </div>

      <div class="form-group">
        <label for="status">Status</label>
        <select name="Status" id="status" required>
          <option value="">--Pilih Status--</option>
        </select>
      </div>

      <div class="form-group">
        <label for="jumlah">Jumlah</label>
        <input type="number" name="Jumlah" id="jumlah" min="0" required />
      </div>

      <div class="form-group">
        <label for="satuan">Satuan</label>
        <select name="Satuan" id="satuan" required>
          <option value="">--Pilih Satuan--</option>
        </select>
      </div>

      <div class="form-group">
        <label for="departement">Departement</label>
        <select name="Departement" id="departement" required>
          <option value="">--Pilih Departement--</option>
        </select>
      </div>

      <div class="button-group">
        <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Kirim Data</button>
        <a href="dashboard.html" class="dashboard-btn"><i class="fas fa-chart-line"></i> Lihat Dashboard</a>
      </div>
    </form>

    <p id="pesan"></p>
  </div>

  <div id="overlay">
    <div class="spinner"></div>
  </div>

  <script>
    const form = document.getElementById('produksiForm');
    const pesan = document.getElementById('pesan');
    const overlay = document.getElementById('overlay');

    const tanggalEl = document.getElementById("tanggal");
    const customerEl = document.getElementById("customer");
    const partNameEl = document.getElementById("partName");
    const partNumberEl = document.getElementById("partNumber");
    const statusEl = document.getElementById("status");
    const jumlahEl = document.getElementById("jumlah");
    const satuanEl = document.getElementById("satuan");
    const departementEl = document.getElementById("departement");

    const API_BASE_URL = "https://api.sheetbest.com/sheets/5c874fef-f659-4e32-aa02-8bef8583f249";

    // Store part data grouped by customer for dynamic updates
    const partList = {};

    // Set today's date automatically
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayString = `${yyyy}-${mm}-${dd}`;
    tanggalEl.value = todayString;

    // --- Master Data Fetching ---
    async function fetchMasterData() {
      try {
        const [customerRes, partRes, statusRes, satuanRes, departementRes] = await Promise.all([
          fetch(`${API_BASE_URL}/tabs/CUSTOMER`),
          fetch(`${API_BASE_URL}/tabs/PART`),
          fetch(`${API_BASE_URL}/tabs/STATUS`),
          fetch(`${API_BASE_URL}/tabs/SATUAN`),
          fetch(`${API_BASE_URL}/tabs/DEPARTEMENT`),
        ]);

        const customerData = await customerRes.json();
        const partData = await partRes.json();
        const statusData = await statusRes.json();
        const satuanData = await satuanRes.json();
        const departementData = await departementRes.json();

        // Populate Customer dropdown
        customerData.forEach(c => {
          if (c.Customer) { // Ensure customer data exists
            const opt = document.createElement("option");
            opt.value = c.Customer;
            opt.textContent = c.Customer;
            customerEl.appendChild(opt);
          }
        });

        // Organize Part data by Customer
        partData.forEach(p => {
          if (p.Customer && p["Part Name"] && p["Part No."]) { // Ensure all relevant part data exists
            if (!partList[p.Customer]) partList[p.Customer] = [];
            partList[p.Customer].push({ name: p["Part Name"], number: p["Part No."] });
          }
        });

        // Populate Status dropdown
        statusData.forEach(s => {
          if (s.Status) {
            const opt = document.createElement("option");
            opt.value = s.Status;
            opt.textContent = s.Status;
            statusEl.appendChild(opt);
          }
        });

        // Populate Satuan dropdown
        satuanData.forEach(s => {
          if (s.Satuan) {
            const opt = document.createElement("option");
            opt.value = s.Satuan;
            opt.textContent = s.Satuan;
            satuanEl.appendChild(opt);
          }
        });

        // Populate Departement dropdown
        departementData.forEach(d => {
          if (d.Departement) {
            const opt = document.createElement("option");
            opt.value = d.Departement;
            opt.textContent = d.Departement;
            departementEl.appendChild(opt);
          }
        });
      } catch (err) {
        console.error("Failed to fetch master data:", err);
        displayMessage("⚠️ Gagal memuat data master. Coba refresh halaman.", "error");
      }
    }

    fetchMasterData();

    // --- Event Listeners for Dynamic Form Fields ---

    customerEl.addEventListener("change", () => {
      const selectedCustomer = customerEl.value;
      partNameEl.innerHTML = '<option value="">--Pilih Part--</option>'; // Reset Part Name
      partNumberEl.value = ""; // Clear Part Number

      if (selectedCustomer && partList[selectedCustomer]) {
        // Sort part names alphabetically for better UX
        const sortedParts = partList[selectedCustomer].sort((a, b) => a.name.localeCompare(b.name));
        sortedParts.forEach(part => {
          const opt = document.createElement("option");
          opt.value = part.name;
          opt.textContent = part.name;
          partNameEl.appendChild(opt);
        });
      }
    });

    partNameEl.addEventListener("change", () => {
      const selectedCustomer = customerEl.value;
      const selectedPartName = partNameEl.value;
      // Find the corresponding part number
      const part = partList[selectedCustomer]?.find(p => p.name === selectedPartName);
      partNumberEl.value = part ? part.number : "";
    });

    // --- Form Submission ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // Prevent default form submission

      overlay.classList.add("show"); // Show loading overlay
      pesan.textContent = ""; // Clear previous messages
      pesan.className = ""; // Clear previous message classes

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      data.Timestamp = new Date().toISOString(); // Add a timestamp

      try {
        const res = await fetch(API_BASE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          displayMessage("✅ Data berhasil dikirim!", "success");
          form.reset(); // Clear form fields
          tanggalEl.value = todayString; // Reset date
          partNameEl.innerHTML = '<option value="">--Pilih Part--</option>'; // Reset Part Name dropdown
          partNumberEl.value = ""; // Clear Part Number
          customerEl.value = ""; // Reset customer dropdown
          // Reset other dropdowns
          statusEl.value = "";
          satuanEl.value = "";
          departementEl.value = "";
        } else {
          const errorData = await res.json();
          console.error("Failed to submit data:", errorData);
          displayMessage(`❌ Gagal mengirim data. Error: ${errorData.message || res.statusText}`, "error");
        }
      } catch (err) {
        console.error("Submission error:", err);
        displayMessage("⚠️ Terjadi kesalahan jaringan. Coba lagi.", "error");
      } finally {
        overlay.classList.remove("show"); // Hide loading overlay
      }
    });

    // Helper function to display messages
    function displayMessage(message, type) {
      pesan.textContent = message;
      pesan.className = ""; // Clear existing classes
      pesan.classList.add(type); // Add success or error class
    }
  </script>
</body>
</html>